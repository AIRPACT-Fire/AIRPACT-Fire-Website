{% extends "base/newbase.html" %}
{% block airpact-content %}

<!-- TODO: Set the width and height programmatically. -->
<div id="map" class="" style="height: 800px; width: 3000px; "> </div>

 <script>

    var centerLat = 45.84921;
    var centerLong = -116.73317;

    var pictures = [];
    var markerList = [];
    var infoWindow;

    // Collect posts and calculate their GPS center-point
    {% for picture in newestPictures %}
      pictures.push(new picture("{{picture.thumbnail.url}}",
        {{picture.geoX}},{{picture.geoY}}, "", "{{picture.user}}",
        "{{picture.description}}", "/picture/view/" + {{picture.id}} + "/"));
    {% endfor %}

    function picture(thumbnailUrl, lat, long, location, user, description, link)
    {
      this.thumbnailUrl = thumbnailUrl;
      this.lat = lat;
      this.long = long;
      this.location = location;
      this.user = user;
      this.description = description;
      this.link = link;
    }

      function initMap() {
        infoWindow = new google.maps.InfoWindow({ content: "hello" });
        var mapDiv = document.getElementById('map');
        var map = new google.maps.Map(mapDiv, {
          center: {lat: centerLat, lng: centerLong},
          zoom: 6,
          mapTypeId: 'hybrid'
        });

        for(i=0; i < pictures.length; i++)
        {
          markerList.push(new google.maps.Marker({
            map:map,
            draggable:false,
            animation: google.maps.Animation.DROP,
            position:{lat:pictures[i].lat, lng:pictures[i].long},
          })
          );
          var br = "<br />";
          var anchor1 = '<a href="'+pictures[i].link+'">';
          var content = '<b>'+pictures[i].user +"</b><br>" + anchor1 +' <img class="img-responsive" src="' + pictures[i].thumbnailUrl + '" alt="{{ picture.pic.url}}" align = "middle" id ="mainPicture" /> </a>'+
          'Posted by: <a href="user/profile/'+pictures[i].user+'/">'+pictures[i].user +"</a><br> Description: " + pictures[i].description;
          google.maps.event.addListener(markerList[i], 'click', (function(content){
            return function(){
           infoWindow.setPosition(this.getPosition());
           infoWindow.setContent( content );
           infoWindow.open(map);
         };

          })(content));
        }

	if (navigator.geolocation) {
		navigator.geolocation.getCurrentPosition(function (position) {
		     initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
		     map.setCenter(initialLocation);
		});
	}

      }

      function adjustMap() {
        $("#map").width($(window).width());
        $("#map").height($(window).height() * .80);
      }

      // TODO: More universal placement of resize function?
      $( window ).resize(function() {
        adjustMap();
      });


      // Loading adjustment
      adjustMap();


    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCp587g3ut0dYnLfl2gfeWTc0fAxujtVcw&callback=initMap"></script>

{% endblock %}
